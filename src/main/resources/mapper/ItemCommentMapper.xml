<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.qbk.web.mapper.ItemCommentMapper">
    <resultMap id="ItemCommentVO" type="com.qbk.entity.vo.ItemCommentVO">
        <id column="id" property="id"/>
        <result column="item_id" property="itemId"/>
        <result column="user_id" property="userId"/>
        <result column="nick_name" property="userNickname"/>
        <result column="score" property="score"/>
        <result column="content" property="content"/>
        <result column="create_time" property="createTime"/>
    </resultMap>

    <insert id="insert" parameterType="com.qbk.entity.ItemComment">
        INSERT INTO tb_item_comment (item_id, order_id, user_id, score, content, create_time, update_time, is_del)
        VALUES (#{itemId}, #{orderId}, #{userId}, #{score}, #{content}, NOW(), NOW(), 0)
    </insert>

    <select id="selectByItemId" resultMap="ItemCommentVO">
        SELECT c.*, u.nick_name
        FROM tb_item_comment c
        LEFT JOIN tb_user u ON c.user_id = u.id
        WHERE c.item_id = #{itemId} AND c.is_del = 0
        <if test="orderBy != null and orderBy != ''">
            ORDER BY ${orderBy}
        </if>
    </select>

    <select id="selectByUserId" resultMap="ItemCommentVO">
        SELECT c.*, u.nick_name
        FROM tb_item_comment c
        LEFT JOIN tb_user u ON c.user_id = u.id
        WHERE c.user_id = #{userId} AND c.is_del = 0
        ORDER BY c.create_time DESC
    </select>

    <select id="selectByOrderId" resultType="com.qbk.entity.ItemComment">
        SELECT * FROM tb_item_comment
        WHERE order_id = #{orderId} AND is_del = 0
    </select>

    <update id="update" parameterType="com.qbk.entity.ItemComment">
        UPDATE tb_item_comment
        SET score = #{score}, content = #{content}, update_time = NOW()
        WHERE id = #{id}
    </update>
</mapper>